---
title: "analysis"
output: html_document
date: "2025-03-03"
---

# Biomarker analysis
## Patient overview (comparison of stable with patients in trancriptomics dataset)

```{r}
l <- list("Patients in\ntranscriptomics dataset" = rna_patients,
          "CLAD patients" = clad_patients, 
          "CLAD-free patients\n(manuscript)" = stable_patients)

p <- 
  ggVennDiagram(l, label_alpha = 0, label_size = 6, label = "count", set_size = 3, set_name_position = c(0.5, 1.5)) + 
  theme(plot.title = element_text(hjust = 0.5, vjust = 1, face = "bold"), 
        legend.position = "none") +
  scale_fill_gradient(low = "white", high = "lightgrey") +
  scale_x_continuous(expand = expansion(mult = c(0.4, 0.4))) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1))) 

l_p <- process_region_data(Venn(l))$item 
names(l_p) <- process_region_data(Venn(l))$name

l_p[[1]]

patients_list %>% filter(Record.ID %in% l_p[[1]])
```

## All medications overview

Only patient 21 took cyclosporin.

```{r}
all_immunosuppression_biomarker <- mmf_df %>%
  mutate(Immunosuppression = "Mycophenolate") %>% 
  full_join(azathioprine_df %>% mutate(Immunosuppression = "Azathioprine")) %>%
  full_join(tacro_df %>% mutate(Immunosuppression = "Tacrolimus")) %>%
  full_join(prednisolone_pulse_df %>% mutate(Immunosuppression = "Prednisolone")) %>%
  filter(Days <= 1000, , Days > 0, Study != "Stable") %>%
  mutate(Record.ID = factor(Record.ID, levels = biomarker_patients),
         Month = round(Days/30.415),
         Immunosuppression_interval = case_when(Days <= 92 ~ "<3 months",
                                         Days > 92 & Days <= 183 ~ "3-6 months",
                                         Days > 183 & Days <= 365 ~ "7-12 months",
                                         Days > 365 ~ ">12 months"), 
         Immunosuppression_interval = factor(Immunosuppression_interval, c("<3 months", "3-6 months", "7-12 months", ">12 months")),
         Months_grouped = case_when(Days <= 42 ~ "<1.5",
                                    Days > 42 & Days <= 92 ~ "1.5-3",
                                    Days > 92 & Days <= 183 ~ "4-6",
                                    Days > 183 & Days <= 273 ~ "7-9",
                                    Days > 273 & Days <= 365 ~ "10-12",
                                    Days > 365 & Days <= 547 ~ "13-18",
                                    Days > 547 ~ ">18"), 
         Months_grouped = factor(Months_grouped, c("<1.5", "1.5-3", "4-6", "7-9", "10-12", "13-18", ">18")) )
```

```{r}
p <- 
  
  ggplot() +
    geom_path(data = all_immunosuppression_biomarker, aes(x = Days, y = Record.ID, group = Record.ID), colour = "grey", size = 1) +
    geom_point(data = all_immunosuppression_biomarker, aes(x = Days, y = Record.ID, fill = Group), shape = 21, stroke = 0.2) +
    geom_point(data = clad_assessment %>% filter(Record.ID %in% biomarker_patients), aes(x = clad_day_clinical, y = factor(Record.ID, levels = biomarker_patients)), shape = 4, colour = "red", size = 2) +
    facet_grid(Group~Immunosuppression, scales = "free", space = "free") +
    theme +
    theme(legend.position = "none") +
    labs(title = "Immunosuppression instances recorded", y = "Patient") +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) 

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/all-imm-instances.jpeg"), p, width = 18, height = 12, units = 'cm', dpi = 600) 
```

## Tacrolimus

```{r}
tacro_biomarker <- all_immunosuppression_biomarker %>% filter(Immunosuppression == "Tacrolimus") 
```

### Levels post-transplant

```{r}
summary(lmer(tacrolimus_level ~ Days*Group + (1|Record.ID), data = tacro_biomarker) ) # no differences between groups and no interaction effect
```

#### Range comparison over months average of all patients together

```{r}
tacro_biomarker_average <- tacro_biomarker %>%
  group_by(Group, Month) %>%
  summarise(tacro_average_levels = mean(tacrolimus_level),
            high = mean(tacrolimus_level) + sd(tacrolimus_level, na.rm = TRUE),
            low  = mean(tacrolimus_level) - sd(tacrolimus_level, na.rm = TRUE)) %>%
  na.omit()

p <- 
  
  ggplot() +
    geom_ribbon(data = tacro_biomarker_average, aes(x = Month, ymin = low, ymax = high, fill = Group), alpha = 0.3, colour = "black", size = 0.2) +
    geom_path(data = tacro_biomarker_average, aes(x = Month, y = tacro_average_levels, colour = Group)) +
    geom_point(data = tacro_biomarker_average, aes(x = Month, y = tacro_average_levels, fill = Group), shape = 21) +
    labs(title = "Tacrolimus trough level post-transplant", y = "Trough level (average per group per month)", 
         caption = "Shading shows the standard deviation\nabove and below the average group trough level") +
    theme +
    theme(legend.position = "bottom") +
    scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_x_continuous(limits = c(0, 26)) 

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/tacrolimus-range-comparison-months.jpeg"), p, width = 9, height = 10, units = 'cm', dpi = 600)
```

#### Patients separate

```{r}
tacro_biomarker_average <- tacro_biomarker %>%
  group_by(Group, Record.ID, Month) %>%
  arrange(Days) %>%
  summarise(tacro_average_levels = mean(tacrolimus_level),
            high = mean(tacrolimus_level) + sd(tacrolimus_level, na.rm = TRUE),
            low  = mean(tacrolimus_level) - sd(tacrolimus_level, na.rm = TRUE)) 

p <- 
  
  ggplot() +
    #geom_ribbon(data = tacro_biomarker_average, aes(x = Month, ymin = low, ymax = high, fill = Group), alpha = 0.3, colour = "black", size = 0.2) +
    geom_path(data = tacro_biomarker_average, aes(x = Month, y = tacro_average_levels, colour = Group, group = Record.ID), size = 0.1) +
    #geom_smooth(data = tacro_biomarker_average, aes(x = Month, y = tacro_average_levels, colour = Group, group = Record.ID), se = FALSE) +
    geom_point(data = tacro_biomarker_average, aes(x = Month, y = tacro_average_levels, fill = Group), shape = 21) +
    labs(title = "Tacrolimus trough level post-transplant", y = "Trough level (average per patient per month)", 
         caption = "Data points from the same patient are connected") +
    theme +
    theme(legend.position = "bottom") +
    scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_x_continuous(limits = c(0, 26))

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/tacrolimus-range-comparison-months-patient.jpeg"), p, width = 9, height = 10, units = 'cm', dpi = 600) 
```

#### Immunosuppression interval

```{r}
tacro_biomarker_average_interval <- tacro_biomarker %>%
  group_by(Group, Months_grouped) %>%
  summarise(tacro_average_levels = mean(tacrolimus_level),
            high = mean(tacrolimus_level) + sd(tacrolimus_level, na.rm = TRUE),
            low  = mean(tacrolimus_level) - sd(tacrolimus_level, na.rm = TRUE)) %>%
  na.omit() 

p <- 
  
  ggplot() +
    geom_rect(data = expected_tacro, aes(xmin = as.numeric(Months_grouped)-0.1, xmax = as.numeric(Months_grouped)+0.1, ymin = min, ymax = max ), alpha = 0.6) +
    geom_path(data = tacro_biomarker_average_interval, aes(x = as.numeric(Months_grouped), y = tacro_average_levels, colour = Group)) +
    geom_point(data = tacro_biomarker_average_interval, aes(x = as.numeric(Months_grouped), y = tacro_average_levels, fill = Group), shape = 21) +
    labs(title = "Tacrolimus trough level post-transplant", y = "Trough level (average per group\nper time point)", 
         x = "Time post-transplant (months)", caption = "Grey area shows expected range") +
    theme +
    theme(legend.position = "bottom") +
    scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_x_continuous(breaks = 1:7, labels = levels(tacro_biomarker_average_interval$Months_grouped))

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/tacrolimus-through-months-grouped.jpeg"), p, width = 9, height = 10, units = 'cm', dpi = 600)
```

#### Immunosuppression interval per patient

```{r}
tacro_biomarker_average_interval <- tacro_biomarker %>%
  group_by(Group, Record.ID, Months_grouped) %>%
  summarise(tacro_average_levels = mean(tacrolimus_level),
            high = mean(tacrolimus_level) + sd(tacrolimus_level, na.rm = TRUE),
            low  = mean(tacrolimus_level) - sd(tacrolimus_level, na.rm = TRUE)) %>%
  na.omit() #%>%
  #pivot_wider(names_from = Group, values_from = tacro_average_levels)

p <- 
  
  ggplot() +
    geom_path(data = tacro_biomarker_average_interval, aes(x = as.numeric(Months_grouped), y = tacro_average_levels, colour = Group, group = Record.ID)) +
    geom_point(data = tacro_biomarker_average_interval, aes(x = as.numeric(Months_grouped), y = tacro_average_levels, fill = Group, group = Record.ID), shape = 21) +
    geom_rect(data = expected_tacro, aes(xmin = as.numeric(Months_grouped)-0.1, xmax = as.numeric(Months_grouped)+0.1, ymin = min, ymax = max ), alpha = 0.6) +
    labs(title = "Tacrolimus trough level post-transplant", y = "Trough level (average per patient\nper time point)", 
         x = "Time post-transplant (months)", caption = "Grey area shows expected range") +
    theme +
    theme(legend.position = "bottom") +
    scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_x_continuous(breaks = 1:7, labels = levels(tacro_biomarker_average_interval$Months_grouped))

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/tacrolimus-through-months-grouped-patients.jpeg"), p, width = 9, height = 10, units = 'cm', dpi = 600) 
```

```{r}
tacro_biomarker_average_interval <- tacro_biomarker %>%
  group_by(Group, Months_grouped) %>%
  summarise(tacro_average_levels = mean(tacrolimus_level),
            high = mean(tacrolimus_level) + sd(tacrolimus_level, na.rm = TRUE),
            low  = mean(tacrolimus_level) - sd(tacrolimus_level, na.rm = TRUE)) %>%
  na.omit() 

d <- tacro_biomarker %>%
  filter(Months_grouped %in% c("<1.5", "10-12", "13-18") ) %>% # still higher at <1.5 months even if outliers > 30 removed
  arrange(Group, Record.ID, Days) 

p <- 
  ggplot(d) +
  geom_path(aes(x = Days, y = tacrolimus_level, group = Record.ID, colour = Group)) +
  geom_point(aes(x = Days, y = tacrolimus_level, fill = Group), shape = 21, alpha = 0.4) +
  geom_hline(data = tacro_biomarker_average_interval %>% filter(Months_grouped %in% c("<1.5", "10-12", "13-18")), aes(yintercept = tacro_average_levels), lty = "dashed") +
  theme +
  labs(title = "Tacrolimus levels (comparison along time intervals)", y = "Trough level", 
       caption = "Dotted line indicates average trough level for time interval in months.\n
       It still remains higher at <1.5 months even if outliers > 30 removed") +
  theme(legend.position = "none") +
  scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
  scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
  facet_grid(~Months_grouped+Group, scales = "free", space = "free") 

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/tacrolimus-through-months-grouped-patients-detail.jpeg"), p, width = 25, height = 10, units = 'cm', dpi = 600) 
```

## ----------------------------
## Prednisolone

```{r}
pred_biomarker <- prednisolone_pulse_df %>%
  ungroup() %>%
  filter(Days <= 1000, Study != "Stable") %>%
  full_join(weight_df[, c("Record.ID", "weight", "Days")]) %>% 
  arrange(Record.ID, Days) %>%
  group_by(Record.ID) %>%
  mutate(weight_interp = round(na.spline(weight, na.rm = FALSE), 2 )) %>%
  filter(Patient_days %in% prednisolone_pulse_df$Patient_days) %>%
  ungroup() %>%
  mutate(Record.ID = factor(Record.ID),
         Month = round(Days/30.415),
         Immunosuppression_interval = case_when(Days <= 92 ~ "<3 months",
                                         Days > 92 & Days <= 183 ~ "3-6 months",
                                         Days > 183 & Days <= 365 ~ "7-12 months",
                                         Days > 365 ~ ">12 months"), 
         Immunosuppression_interval = factor(Immunosuppression_interval, c("<3 months", "3-6 months", "7-12 months", ">12 months")),
         Months_grouped = case_when(Days <= 42 ~ "<1.5",
                                    Days > 42 & Days <= 92 ~ "1.5-3",
                                    Days > 92 & Days <= 183 ~ "4-6",
                                    Days > 183 & Days <= 273 ~ "7-9",
                                    Days > 273 & Days <= 365 ~ "10-12",
                                    Days > 365 & Days <= 547 ~ "13-18",
                                    Days > 547 ~ ">18"), 
         Months_grouped = factor(Months_grouped, c("<1.5", "1.5-3", "4-6", "7-9", "10-12", "13-18", ">18")) ) %>% 
  left_join(expected_pred) %>%
  mutate(expected_dose_mg = case_when(Months_grouped %in% c("<1.5", "1.5-3", "4-6", "7-9", "10-12") ~ mg_per_kg * weight_interp,
                                        Months_grouped %in% c("13-18", ">18") ~ mg_per_kg),
         prednisolone_pulse_dose_mgd_per_kg = round(prednisolone_pulse_dose_mgd / weight_interp, 2) )
```

### Levels post-transplant

```{r}
summary(lmer(tacrolimus_level ~ Days*Group + (1|Record.ID), data = tacro_biomarker) ) # no differences between groups and no interaction effect
```

#### Range comparison over months average of all patients together

```{r}
pred_biomarker_average <- pred_biomarker %>%
  filter(pulse == "No") %>% 
  group_by(Group, Month, pulse) %>%
  summarise(pred_average_levels = mean(prednisolone_pulse_dose_mgd_per_kg), # reported levels per patient interpolated kg
            high = mean(prednisolone_pulse_dose_mgd_per_kg) + sd(prednisolone_pulse_dose_mgd_per_kg, na.rm = TRUE),
            low  = mean(prednisolone_pulse_dose_mgd_per_kg) - sd(prednisolone_pulse_dose_mgd_per_kg, na.rm = TRUE)) 

p <- 
  
  ggplot() +
    geom_ribbon(data = pred_biomarker_average, aes(x = Month, ymin = low, ymax = high, fill = Group), alpha = 0.3, colour = "black", size = 0.2) +
    geom_path(data = pred_biomarker_average, aes(x = Month, y = pred_average_levels, colour = Group)) +
    geom_point(data = pred_biomarker_average, aes(x = Month, y = pred_average_levels, fill = Group), shape = 21) +
    labs(title = "Prednisolone post-transplant\n(excluding pulses)", y = "mg (daily average per group)",
         caption = "Shading shows the standard deviation\nabove and below the average group trough level") +
    theme +
    theme(legend.position = "bottom") +
    scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_x_continuous(limits = c(0, 26)) +
    geom_vline(xintercept = 12, lty = "dashed", colour = "grey")

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/pred-range-comparison-months.jpeg"), p, width = 9, height = 10, units = 'cm', dpi = 600) 


# patients separate
pred_biomarker_average <- pred_biomarker %>%
  filter(pulse == "No") %>% 
  group_by(Group, Record.ID, Month) %>%
  summarise(pred_average_levels = mean(prednisolone_pulse_dose_mgd_per_kg), # reported levels
            high = mean(prednisolone_pulse_dose_mgd_per_kg) + sd(prednisolone_pulse_dose_mgd_per_kg, na.rm = TRUE),
            low  = mean(prednisolone_pulse_dose_mgd_per_kg) - sd(prednisolone_pulse_dose_mgd_per_kg, na.rm = TRUE)) 

p <- 
  
  ggplot() +
    #geom_ribbon(data = tacro_biomarker_average, aes(x = Month, ymin = low, ymax = high, fill = Group), alpha = 0.3, colour = "black", size = 0.2) +
    #geom_path(data = pred_biomarker_average, aes(x = Month, y = pred_average_levels, colour = Group, group = Record.ID), size = 0.1) +
    geom_smooth(data = tacro_biomarker_average, aes(x = Month, y = tacro_average_levels, colour = Group, group = Record.ID), se = FALSE) +
    #geom_jitter(data = pred_biomarker_average, aes(x = Month, y = pred_average_levels, fill = Group), shape = 21, width = 0.6, alpha = 0.6) +
    labs(title = "Prednisolone post-transplant\n(excluding pulses)", y = "mg daily (average per patient per month)",
         caption = "Data points from the same patient are connected") +
    theme +
    theme(legend.position = "bottom") +
    scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_x_continuous(limits = c(0, 26)) +
    geom_vline(xintercept = 12, lty = "dashed", colour = "grey")

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/pred-range-comparison-months-patient.jpeg"), p, width = 9, height = 10, units = 'cm', dpi = 600) 
```

#### Accounding for weight and checking each individual patient (cannot compare between patients)

```{r, fig.height=5, fig.width=20}
pred_biomarker_average_patient <- pred_biomarker %>%
  filter(pulse == "No") %>% 
  group_by(Group, Record.ID, Months_grouped) %>%
  summarise("Reported" = mean(prednisolone_pulse_dose_mgd), 
            "Expected" = mean(expected_dose_mg))  %>%
  pivot_longer(Reported:Expected, names_to = "Dose", values_to = "Level") %>%
  arrange(Group, Record.ID, Months_grouped) %>%
  mutate(Record.ID = factor(as.character(Record.ID)))

p <- 
  
  ggplot(pred_biomarker_average_patient, aes(x = as.numeric(Months_grouped), y = Level)) +
    geom_point(aes(fill = Dose), shape = 21) +
    geom_path(aes(colour = Dose, group = Dose)) +
    labs(title = "Prednisolone post-transplant (excluding pulses)", y = "mg (average)", x = "Time post-transplant (months)") +
    theme +
    scale_colour_manual(values = c("Reported" = "blue", "Expected" = "darkgrey")) +
    scale_fill_manual(values = c("Reported" = "blue", "Expected" = "darkgrey")) +
    facet_wrap(Group~Record.ID, nrow = 2) +
    scale_x_continuous(breaks = 1:7, labels = levels(pred_biomarker_average_patient$Months_grouped)) 

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/pred-range-comparison-months-weight-patient.jpeg"), p, width = 40, height = 10, units = 'cm', dpi = 600)
```

```{r}
d <- pred_biomarker %>%
  filter(pulse == "No") %>% 
  group_by(Group, Record.ID, Months_grouped) %>%
  summarise("Reported" = mean(prednisolone_pulse_dose_mgd), 
            "Expected" = mean(expected_dose_mg)) %>%
  mutate(Difference = Reported - Expected,
         Difference = ifelse(Difference > 0, "Higher than expected", "Lower than expected")) 

ggplot(d, aes(x = Months_grouped, y = Record.ID)) +
  geom_tile(aes(fill = Difference)) +
  theme +
  labs(title = "Prednisolone post-transplant (excluding pulses)", y = "Patient", x = "Time post-transplant (months)") +
  facet_grid(Group~., scales = "free", space = "free") +
  scale_fill_manual(values = c("Higher than expected" = "pink", "Lower than expected" = "lightgreen")) 
```

#### Immunosuppression interval

```{r}
pred_biomarker_average_interval <- pred_biomarker %>%
  filter(pulse == "No") %>%
  group_by(Group, Months_grouped) %>%
  summarise(pred_average_levels = mean(prednisolone_pulse_dose_mgd_per_kg),
            high = mean(prednisolone_pulse_dose_mgd_per_kg) + sd(prednisolone_pulse_dose_mgd_per_kg, na.rm = TRUE),
            low  = mean(prednisolone_pulse_dose_mgd_per_kg) - sd(prednisolone_pulse_dose_mgd_per_kg, na.rm = TRUE)) %>%
  na.omit() 

p <- 
  
  ggplot() +
    #geom_rect(data = expected_pred, aes(xmin = as.numeric(Months_grouped)-0.1, xmax = as.numeric(Months_grouped)+0.1, ymin = min, ymax = max ), alpha = 0.6) +
    geom_path(data = pred_biomarker_average_interval, aes(x = as.numeric(Months_grouped), y = pred_average_levels, colour = Group)) +
    geom_point(data = pred_biomarker_average_interval, aes(x = as.numeric(Months_grouped), y = pred_average_levels, fill = Group), shape = 21) +
    labs(title = "Prednisolone post-transplant", y = "mg/kg daily (average per group\nper time point)", 
         x = "Time post-transplant (months)") +
    theme +
    theme(legend.position = "bottom") +
    scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_x_continuous(breaks = 1:7, labels = levels(pred_biomarker_average_interval$Months_grouped))

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/pred-through-months-grouped.jpeg"), p, width = 9, height = 10, units = 'cm', dpi = 600) 


# immunosuppression interval per patient
pred_biomarker_average_interval <- pred_biomarker %>%
  filter(pulse == "No") %>%
  group_by(Group, Record.ID, Months_grouped) %>%
  summarise(pred_average_levels = mean(prednisolone_pulse_dose_mgd_per_kg),
            high = mean(prednisolone_pulse_dose_mgd_per_kg) + sd(prednisolone_pulse_dose_mgd_per_kg, na.rm = TRUE),
            low  = mean(prednisolone_pulse_dose_mgd_per_kg) - sd(prednisolone_pulse_dose_mgd_per_kg, na.rm = TRUE)) %>%
  na.omit() 
p <- 
  
  ggplot() +
    geom_path(data = pred_biomarker_average_interval, aes(x = as.numeric(Months_grouped), y = pred_average_levels, colour = Group, group = Record.ID)) +
    geom_point(data = pred_biomarker_average_interval, aes(x = as.numeric(Months_grouped), y = pred_average_levels, fill = Group, group = Record.ID), shape = 21) +
    #geom_rect(data = expected_pred, aes(xmin = as.numeric(Months_grouped)-0.1, xmax = as.numeric(Months_grouped)+0.1, ymin = min, ymax = max ), alpha = 0.6) +
    labs(title = "Prednisolone post-transplant", y = "mg/kg daily (average per patient\nper time point)", 
         x = "Time post-transplant (months)") +
    theme +
    theme(legend.position = "bottom") +
    scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_x_continuous(breaks = 1:7, labels = levels(pred_biomarker_average_interval$Months_grouped))

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/pred-months-grouped-patients.jpeg"), p, width = 9, height = 10, units = 'cm', dpi = 600) 
```

```{r}
summary(lmer(prednisolone_dose_mgd ~ Days*Group + (1|Record.ID), data = prednisolone_df) )

summary(lmer(prednisolone_pulse_dose_mgd ~ Days*Group + (1|Record.ID), data = prednisolone_pulse_df) )
```

### Pulse

```{r}
pulse_patients <- pred_biomarker %>% 
  filter(pulse == "Yes") %>% 
  pull(Record.ID)

pulse_biomarker <- pred_biomarker %>% 
  filter(Record.ID %in% c(pulse_patients) )

spirometry <- readRDS(paste0(path, "Biomarker 2/clad-bal-multiomics-bm2/clinical-metadata-formatting/rsd_files/spirometry_metadata.rds") ) %>%
  filter(Days < 1000) %>%
  mutate(Record.ID = factor(Record.ID)) %>%
  filter(Record.ID %in% pulse_patients) 

p <- 
  ggplot() +
    geom_point(data = spirometry, aes(x = Days, y = FEV1_pre_percentage, fill = Group), shape = 21) +
    geom_path(data = spirometry, aes(x = Days, y = FEV1_pre_percentage, color = Group)) +
    geom_point(data = pulse_biomarker %>% filter(pulse == "Yes"), aes(x = Days, y = 120), shape = 4, color = "red") +
    theme +
    theme(legend.position = "bottom") +
    labs(title = "Patients that received a Prednisolone pulse", y = "FEV1 predicted %") +
    facet_wrap(~Record.ID) +
    scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) 

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/pred-fev-pulse-patients.jpeg"), p, width = 12, height = 12, units = 'cm', dpi = 600) 
```

## ----------------------------

## Correlation with DE genes and DA molecules

```{r}
# merge immunosuppression data with data 
tacro_biomarker_average <- tacro_biomarker %>%
  group_by(Group, Record.ID, Month) %>%
  arrange(Days) %>%
  summarise(tacro_average_levels = mean(tacrolimus_level)) 

pred_biomarker_average <- pred_biomarker %>%
  filter(pulse == "No") %>% 
  group_by(Group, Record.ID, Month) %>%
  summarise(pred_average_levels = mean(prednisolone_pulse_dose_mgd_per_kg)) 

t_p_average <- tacro_biomarker_average %>% 
  full_join(pred_biomarker_average) %>%
  ungroup() %>%
  mutate(Record_month = paste(Record.ID, Month, sep = "_")) %>%
  dplyr::select(!c("Group", "Record.ID", "Month")) %>%
  column_to_rownames("Record_month") %>%
  dplyr::rename(Tacrolimus = tacro_average_levels, Prednisolone = pred_average_levels)
```

```{r}
#rna_combined_heat <- as.data.frame(deseq_list$`group+months`$GroupCLAD$heat_sig) 

biomarker_rna_combined <- deseq_list$`group+months`$GroupCLAD$sig_results_df %>%
  filter(abs(log2FoldChange) >= 1) %>%
  pull(Gene)

# using actual normalised counts, not scaled counts
rna_combined_heat <- assay(deseq_list$`group+months`$vsd)[biomarker_rna_combined, ] 

rna_combined_heat_intervals <- rna_combined_heat %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  left_join(biomarker_rna_metadata[, c("Patient_days", "Month", "Record.ID", "Group")]) %>%
  dplyr::select(!c("Patient_days")) %>%
  group_by(Group, Record.ID, Month) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  mutate(Record_month = paste(Record.ID, Month, sep = "_")) %>%
  dplyr::select(!c("Group", "Record.ID", "Month")) %>%
  column_to_rownames("Record_month") %>%
  t() %>%
  as.data.frame()

# correlate
correlation_list <- list()

df1 <- t_p_average %>% filter(rownames(.) %in% colnames(rna_combined_heat_intervals))
df2 <- rna_combined_heat_intervals #%>% filter(rownames(.) %in% unique_features$Molecule)

correlation_list[["Genes"]] <- correlate_datasets(df1 = df1, 
                     df2 = df2, 
                     df1_type = "Immunosuppression", df2_type = "Genes", 
                     plots = FALSE, 
                     coef_threshold = 0, correlation = "pearson", pval_threshold = 1)
```

```{r}
#molecules_combined_heat <- as.data.frame(molecules_list$`group+months`$GroupCLAD$heat_sig_hits) 

molecules_combined_heat_intervals <- biomarker_small_molecules[molecules_list$`group+months`$GroupCLAD$sig_hits$Molecule,] %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Patient_days") %>%
  left_join(biomarker_small_molecules_metadata[, c("Patient_days", "Month", "Record.ID", "Group")]) %>%
  dplyr::select(!c("Patient_days")) %>%
  group_by(Group, Record.ID, Month) %>%
  summarise(across(where(is.numeric), mean)) %>%
  ungroup() %>%
  mutate(Record_month = paste(Record.ID, Month, sep = "_")) %>%
  dplyr::select(!c("Group", "Record.ID", "Month")) %>%
  column_to_rownames("Record_month") %>%
  t() %>%
  as.data.frame()

df1 <- t_p_average %>% filter(rownames(.) %in% colnames(molecules_combined_heat_intervals))
df2 <- molecules_combined_heat_intervals #%>% filter(rownames(.) %in% unique_features$Molecule)

correlation_list[["Molecules"]] <- correlate_datasets(df1 = df1, 
                     df2 = df2, 
                     df1_type = "Immunosuppression", df2_type = "Molecules", 
                     plots = FALSE, 
                     coef_threshold = 0, correlation = "pearson", pval_threshold = 1)
```

```{r}
a <- correlation_list$Genes$coef_df %>% 
  dplyr::rename(Feature = df2_name) 

b <- correlation_list$Molecules$coef_df %>% 
  dplyr::rename(Feature = df2_name) 

corr_table <- rbind(a, b) %>% 
  dplyr::rename(Immunosuppression = df1_name) %>%
  mutate(Correlation2 = ifelse(pval >= 0.05, 0, Correlation),
         Sign = case_when(Correlation2 > 0 ~ "+", 
                          Correlation2 == 0 ~ "", 
                          Correlation2 < 0 ~ "-"), 
         Significance = case_when(pval >= 0.05 ~ "",
                                      pval < 0.05 & pval >= 0.01 ~ "*",
                                      pval < 0.01 & pval >= 0.001 ~ "**",
                                      pval < 0.001 & pval >= 0.0001 ~ "***",
                                      pval < 0.0001 ~ "****") )

p <- 
  ggplot(corr_table %>% filter(pval < 0.05), aes(x = Immunosuppression, y = Feature)) +
    geom_point(aes(size = -log(pval)), colour = "grey", stroke = 1) +
    geom_point(aes(colour = Correlation2, size = -log(pval))) +
    geom_text(aes(size = -log(pval), label = Sign), nudge_y = 0.1) +
    geom_text(aes(label = Significance), nudge_x = 0.15, nudge_y = 0.1) +
    facet_grid(df2_type~., scales = "free", space = "free") +
    labs(title = "Immunosuppression correlations", x = "", colour = "Pearson (r)", y = "Metabolite", size = "-Log(p-val)") +
    theme +
    theme(strip.text.y = element_text(angle = 0, size = 6),
          legend.key.size = unit(0.4, 'cm'),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 6)) +
    guides(fill = "none") +
    scale_colour_gradient2(low = "grey" , mid = "white", high = "orange")

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/summary-correlation.jpeg"), p, width = 13, height = 12, units = 'cm', dpi = 600) 
```

```{r}
data <- rna_combined_heat_intervals %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Record_month") %>%
  pivot_longer(!Record_month, names_to = "Gene", values_to = "Value") %>%
  left_join(t_p_average %>% rownames_to_column("Record_month")) %>%
  left_join(biomarker_rna_metadata %>% 
              mutate(Record_month = paste(Record.ID, Month, sep = "_")) %>% 
              dplyr::select(Record.ID, Record_month, Group) %>% distinct() )

sig_features <- corr_table %>%
  filter(pval < 0.05, Immunosuppression == "Tacrolimus") %>%
  pull(Feature) %>%
  unique()

p <-

  ggplot(data %>% filter(Gene %in% sig_features), aes(x = Tacrolimus, y = Value)) +
    geom_smooth(aes(group = Gene), method = "lm", colour = "darkgrey", lty = "dashed") +
    geom_point(aes(fill = Group), shape = 21, size = 1) +
    theme +
    labs(title = "Tacrolimus correlation", x = "Trough level", y = "Gene intensity", fill = "Group", 
         caption = "Each dot point is the average per patient per month") +
    facet_wrap(~Gene, ncol = 5, scales = "free_y") +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) 

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/tacro-genes-correlation.jpeg"), p, width = 22, height = 8, units = 'cm', dpi = 600) 


sig_features <- corr_table %>%
  filter(pval < 0.05, Immunosuppression == "Prednisolone") %>%
  pull(Feature) %>%
  unique()

p <- 
  ggplot(data %>% filter(Gene %in% sig_features), aes(x = Prednisolone, y = Value)) +
    geom_smooth(aes(group = Gene), method = "lm", colour = "darkgrey", lty = "dashed") +
    geom_point(aes(fill = Group), shape = 21, size = 1) +
    theme +
    labs(title = "Prednisolone correlation", x = "mg (daily)", y = "Gene intensity", fill = "Group", 
         caption = "Each dot point is the average per patient per month") +
    facet_wrap(~Gene, ncol = 5, scales = "free_y") +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) 

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/pred-genes-correlation.jpeg"), p, width = 22, height = 12, units = 'cm', dpi = 600) 
```

```{r}
data <- molecules_combined_heat_intervals %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Record_month") %>%
  pivot_longer(!Record_month, names_to = "Molecule", values_to = "Value") %>%
  left_join(t_p_average %>% rownames_to_column("Record_month")) %>%
  left_join(biomarker_small_molecules_metadata %>% 
              mutate(Record_month = paste(Record.ID, Month, sep = "_")) %>% 
              dplyr::select(Record.ID, Record_month, Group) %>% distinct() ) 
unique(data$Molecule) # 9

sig_features <- corr_table %>%
  filter(pval < 0.05, Immunosuppression == "Tacrolimus") %>%
  pull(Feature) %>%
  unique()

p <- 
  ggplot(data %>% filter(Molecule %in% sig_features), aes(x = Tacrolimus, y = Value)) +
    geom_smooth(aes(group = Molecule), method = "lm", colour = "darkgrey", lty = "dashed") +
    geom_point(aes(fill = Group), shape = 21, size = 1) +
    theme +
    labs(title = "Tacrolimus correlation", x = "Trough level", y = "Metabolite intensity", fill = "Group", 
         caption = "Each dot point is the average per patient per month") +
    facet_wrap(~Molecule, ncol = 3, scales = "free_y") +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) 

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/tacro-molecules-correlation.jpeg"), p, width = 17, height = 5, units = 'cm', dpi = 600) 


sig_features <- corr_table %>%
  filter(pval < 0.05, Immunosuppression == "Prednisolone") %>%
  pull(Feature) %>%
  unique()

p <- 
  ggplot(data %>% filter(Molecule %in% sig_features), aes(x = Prednisolone, y = Value)) +
    geom_smooth(aes(group = Molecule), method = "lm", colour = "darkgrey", lty = "dashed") +
    geom_point(aes(fill = Group), shape = 21, size = 1) +
    theme +
    labs(title = "Prednisolone correlation", x = "mg (daily)", y = "Metabolite intensity", fill = "Group", 
         caption = "Each dot point is the average per patient per month") +
    facet_wrap(~Molecule, ncol = 3, scales = "free_y") +
    scale_fill_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) 

ggsave(paste0(path, "Biomarker\ 2/immunosuppression-analysis/figures/pred-molecules-correlation.jpeg"), p, width = 17, height = 12 , units = 'cm', dpi = 600) 
```

## MOFA signature

```{r}
immunosuppression_list$tacro_matched_df <- match_immunosuppressants(mofa_metadata, immunosuppression_list$tacro_df[, c("Record.ID", "Days", "tacrolimus_level")], patients = unique(mofa_metadata$Record.ID), buffer = 3)

immunosuppression_list$prednisolone_pulse_matched_df <- match_immunosuppressants(mofa_metadata, immunosuppression_list$prednisolone_pulse_df[, c("Record.ID", "Days", "prednisolone_pulse_dose_mgd")], patients = unique(mofa_metadata$Record.ID), buffer = 3)

immunosuppression_list$mmf_matched_df <- match_immunosuppressants(mofa_metadata, immunosuppression_list$mmf_df[, c("Record.ID", "Days", "mmf_dose_gd")], patients = unique(mofa_metadata$Record.ID), buffer = 3)

immunosuppression_list$azathioprine_matched_df <- match_immunosuppressants(mofa_metadata, immunosuppression_list$azathioprine_df[, c("Record.ID", "Days", "azathioprine_dose_mgd")], patients = unique(mofa_metadata$Record.ID), buffer = 3)

mofa_metadata <- mofa_metadata %>%
  left_join(immunosuppression_list$tacro_matched_df) %>%
  left_join(immunosuppression_list$prednisolone_pulse_matched_df) %>%
  left_join(immunosuppression_list$mmf_matched_df) %>%
  left_join(immunosuppression_list$azathioprine_matched_df) 
```

```{r}
d1 <- prednisolone_df %>%
  filter(Days <= 900, Study != "Stable") 

d2 <- pulse_df %>%
  filter(Days <= 900, Study != "Stable") 
  
ggplot() +
    # Overlay multiomics signature
  geom_smooth(data = latent_factors, aes(x = Days, y = Factor1, group = Group, colour = Group), method = "lm", formula = y ~ ns(x, 2), linewidth = 0.8, se = FALSE) +
  # Overlay pulse and prednisoone intake
  geom_smooth(data = d1, aes(x = Days, y = prednisolone_dose_mgd, group = Group, colour = Group)) +
  #geom_point(data = d1, aes(x = Days, y = prednisolone_dose_mgd, colour = Group, shape = pulse)) +
  geom_point(data = d2, aes(x = Days, y = pulse_dose, colour = Group, shape = pulse) ) +
  labs(title = "Prednisolone", shape = "Pulse") +
  theme +
  facet_wrap(~Record.ID) +
  #scale_y_log10() +
  scale_colour_manual(values = c("CLAD" = "orange", "CLAD-free" = "darkgrey")) +
  scale_shape_manual(values = c("Yes" = 4, "No" = 21)) +
  scale_y_continuous(name = "Value", sec.axis = sec_axis(trans=~.*1, name = "mg/d") )
```


